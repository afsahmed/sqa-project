name: Run Unit Tests (Mocha + Chai)

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin
          POSTGRES_DB: SQA-Project-Test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      NODE_ENV: test
      DB_NAME_TEST: SQA-Project-Test
      DB_USER: postgres
      DB_PASS: admin
      DB_HOST: localhost
      DB_PORT: 5432
      DB_DIALECT: postgres
      JWT_SECRET: sqa-node-backend
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      TO_EMAIL: ${{ secrets.TO_EMAIL }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install

      - name: Run Tests and Generate Fully Inline Report
        run: |
          mkdir -p reports

          # Run mocha tests and generate JSON reports
          npx mocha "test/**/*.js" \
            --reporter mochawesome \
            --reporter-options reportDir=reports,reportFilename=mocha-report,saveJson=true,quiet=false

          # Merge all JSON reports (if multiple)
          npx mochawesome-merge reports/*.json > reports/merged-output.json

          # Generate fully self-contained HTML report (inline CSS/JS)
          npx mochawesome-report-generator reports/merged-output.json \
            --reportDir reports \
            --reportFilename mocha-report \
            --inline true \
            --inlineAssets true \
            --cdn false

          echo "Generated report size:"
          ls -lh reports/mocha-report.html

      - name: Zip Entire Reports Folder
        if: failure()
        run: |
          cd reports
          zip -r ../mocha-report.zip .
          cd ..
          echo "Zipped report size:"
          ls -lh mocha-report.zip

      - name: Upload Test Report (only on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mocha-report
          path: reports/

      - name: Send Failure Email with Zipped Report
        if: failure()
        run: |
          echo "Encoding zip report..."
          BASE64_CONTENT=$(base64 -w 0 mocha-report.zip)

          echo "Sending email via SendGrid..."
          curl --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer $SENDGRID_API_KEY" \
            --header 'Content-Type: application/json' \
            --data "{
              \"personalizations\": [{
                \"to\": [{\"email\": \"${TO_EMAIL}\"}],
                \"subject\": \"Test Run Failed: Mochawesome Report Attached\"
              }],
              \"from\": {\"email\": \"${FROM_EMAIL}\", \"name\": \"SQA CI Bot\"},
              \"content\": [{
                \"type\": \"text/plain\",
                \"value\": \"One or more tests failed during CI. See attached Mochawesome report ZIP.\"
              }],
              \"attachments\": [{
                \"content\": \"${BASE64_CONTENT}\",
                \"type\": \"application/zip\",
                \"filename\": \"mocha-report.zip\"
              }]
            }"
