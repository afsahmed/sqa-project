name: Run Unit Tests (Mocha + Chai)

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin
          POSTGRES_DB: SQA-Project-Test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      NODE_ENV: test
      DB_NAME_TEST: SQA-Project-Test
      DB_USER: postgres
      DB_PASS: admin
      DB_HOST: localhost
      DB_PORT: 5432
      DB_DIALECT: postgres
      JWT_SECRET: sqa-node-backend
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      TO_EMAIL: ${{ secrets.TO_EMAIL }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install

      - name: Run Tests and Capture Output
        id: run_tests
        run: |
          # Run mocha tests and capture full output
          mkdir -p test-output
          npx mocha "test/**/*.js" --reporter spec 2>&1 | tee test-output/mocha-output.txt
          TEST_EXIT_CODE=${PIPESTATUS[0]}
          echo "exit_code=$TEST_EXIT_CODE" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Send Failure Email
        if: steps.run_tests.outputs.exit_code != '0'
        run: |
          echo "Preparing test failure email..."
          
          # Base64 encode the test output for safe attachment
          BASE64_CONTENT=$(base64 -w 0 test-output/mocha-output.txt)

          curl --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer $SENDGRID_API_KEY" \
            --header 'Content-Type: application/json' \
            --data "{
              \"personalizations\": [{
                \"to\": [{\"email\": \"${TO_EMAIL}\"}],
                \"subject\": \"CI Test Failures\"
              }],
              \"from\": {\"email\": \"${FROM_EMAIL}\", \"name\": \"SQA CI Bot\"},
              \"content\": [{
                \"type\": \"text/plain\",
                \"value\": \"One or more tests failed. See attached test output.\"
              }],
              \"attachments\": [{
                \"content\": \"${BASE64_CONTENT}\",
                \"type\": \"text/plain\",
                \"filename\": \"mocha-test-output.txt\"
              }]
            }"
