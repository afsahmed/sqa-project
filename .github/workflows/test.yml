name: Run Unit Tests (Mocha + Chai)

on:
  push:
    branches: [ "dev" ]
  pull_request:
    branches: [ "dev" ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      postgres:
        image: postgres:14
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: admin
          POSTGRES_DB: SQA-Project-Test
        ports:
          - 5432:5432
        options: >-
          --health-cmd="pg_isready -U postgres"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    env:
      NODE_ENV: test
      DB_NAME_TEST: SQA-Project-Test
      DB_USER: postgres
      DB_PASS: admin
      DB_HOST: localhost
      DB_PORT: 5432
      DB_DIALECT: postgres
      JWT_SECRET: sqa-node-backend
      SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}
      TO_EMAIL: ${{ secrets.TO_EMAIL }}
      FROM_EMAIL: ${{ secrets.FROM_EMAIL }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: npm install

      - name: Run Tests (Generate Report)
        run: |
          mkdir -p reports
          npx mocha "test/**/*.js" \
            --reporter mochawesome \
            --reporter-options reportDir=reports,reportFilename=mocha-report,quiet=true

      - name: Upload Test Report (only on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: mocha-report
          path: reports/

      - name: Send Failure Email (only on failure)
        if: failure()
        run: |
          echo "Preparing to send email notification..."
          REPORT_PATH="reports/mocha-report.html"
          
          if [ ! -f "$REPORT_PATH" ]; then
            echo "Report not found, creating fallback text file..."
            echo "Tests failed but no HTML report generated." > report.txt
            REPORT_PATH="report.txt"
          fi

          echo "Encoding report..."
          BASE64_CONTENT=$(base64 -w 0 "$REPORT_PATH")

          echo "Sending email via SendGrid..."
          curl --request POST \
            --url https://api.sendgrid.com/v3/mail/send \
            --header "Authorization: Bearer $SENDGRID_API_KEY" \
            --header 'Content-Type: application/json' \
            --data "{
              \"personalizations\": [{
                \"to\": [{\"email\": \"${TO_EMAIL}\"}],
                \"subject\": \"Test Run Failed: Mocha Report Attached\"
              }],
              \"from\": {\"email\": \"${FROM_EMAIL}\", \"name\": \"SQA CI Bot\"},
              \"content\": [{
                \"type\": \"text/plain\",
                \"value\": \"One or more tests failed in CI. See attached report.\"
              }],
              \"attachments\": [{
                \"content\": \"${BASE64_CONTENT}\",
                \"type\": \"text/html\",
                \"filename\": \"mocha-report.html\"
              }]
            }"
